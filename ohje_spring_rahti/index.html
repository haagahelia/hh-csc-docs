
<!DOCTYPE html>

<html class="no-js" lang="fi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../ohje_opettaja/" rel="prev"/>
<link href="../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.5.3, mkdocs-material-9.4.10" name="generator"/>
<title>Spring Boot-palvelun julkaisu - CSC-palvelut Haaga-Heliassa</title>
<link href="../assets/stylesheets/main.fad675c6.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#spring-boot-palvelun-julkaiseminen-rahti-ymparistossa">
          Hyppää sisältöön
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="CSC-palvelut Haaga-Heliassa" class="md-header__button md-logo" data-md-component="logo" href=".." title="CSC-palvelut Haaga-Heliassa">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            CSC-palvelut Haaga-Heliassa
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Spring Boot-palvelun julkaisu
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Hae" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Hae" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="..">
        
  
    
  
  Aloitus

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../ohje_opettaja/">
        
  
    
  
  Ohjeet opettajalle

      </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="./">
        
  
    
  
  Spring Boot-palvelun julkaisu

      </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="CSC-palvelut Haaga-Heliassa" class="md-nav__button md-logo" data-md-component="logo" href=".." title="CSC-palvelut Haaga-Heliassa">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    CSC-palvelut Haaga-Heliassa
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="..">
<span class="md-ellipsis">
    Aloitus
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ohje_opettaja/">
<span class="md-ellipsis">
    Ohjeet opettajalle
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Spring Boot-palvelun julkaisu
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Spring Boot-palvelun julkaisu
  </span>
</a>
<nav aria-label="Sisällysluettelo" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Sisällysluettelo
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#johdanto">
<span class="md-ellipsis">
      Johdanto
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#rahti-projektin-luonti">
<span class="md-ellipsis">
      Rahti-projektin luonti
    </span>
</a>
<nav aria-label="Rahti-projektin luonti" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#openshift-komentorivityokalun-asennus">
<span class="md-ellipsis">
      Openshift-komentorivityökalun asennus
    </span>
</a>
<nav aria-label="Openshift-komentorivityökalun asennus" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#asennus-windows-ymparistossa">
<span class="md-ellipsis">
      Asennus Windows-ympäristössä
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#rahti-palveluun-kirjautuminen-komentorivilla">
<span class="md-ellipsis">
      Rahti-palveluun kirjautuminen komentorivillä
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tietokantapalvelun-luominen">
<span class="md-ellipsis">
      Tietokantapalvelun luominen
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#spring-boot-palvelimen-julkaisu">
<span class="md-ellipsis">
      Spring Boot -palvelimen julkaisu
    </span>
</a>
<nav aria-label="Spring Boot -palvelimen julkaisu" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#julkaisu-yksityisesta-github-repositoriosta">
<span class="md-ellipsis">
      Julkaisu yksityisestä GitHub-repositoriosta
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#julkaisu-source-to-image-tyokaluilla">
<span class="md-ellipsis">
      Julkaisu Source-to-Image-työkaluilla
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#julkaisu-dockerfilen-perusteella">
<span class="md-ellipsis">
      Julkaisu Dockerfile:n perusteella
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#julkaisu-paikallisesta-hakemistosta-jkube-openshift-maven-pluginilla">
<span class="md-ellipsis">
      Julkaisu paikallisesta hakemistosta JKube OpenShift Maven pluginilla
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#buildin-kaynnistaminen">
<span class="md-ellipsis">
      Buildin käynnistäminen
    </span>
</a>
<nav aria-label="Buildin käynnistäminen" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#buildin-automatisointi">
<span class="md-ellipsis">
      Buildin automatisointi
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#spring-boot-palvelimen-konfigurointi-kayttamaan-ulkoista-tietokantapalvelua">
<span class="md-ellipsis">
      Spring Boot -palvelimen konfigurointi käyttämään ulkoista tietokantapalvelua
    </span>
</a>
<nav aria-label="Spring Boot -palvelimen konfigurointi käyttämään ulkoista tietokantapalvelua" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#julkaisuprofiilin-luonti-spring-projektiin">
<span class="md-ellipsis">
      Julkaisuprofiilin luonti Spring-projektiin
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ymparistomuuttujien-asettaminen">
<span class="md-ellipsis">
      Ympäristömuuttujien asettaminen
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ymparistomuuttujien-asettaminen-jkube-openshift-maven-pluginia-kaytettaessa">
<span class="md-ellipsis">
      Ympäristömuuttujien asettaminen JKube OpenShift Maven pluginia käytettäessä
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#https-konfigurointi">
<span class="md-ellipsis">
      HTTPS-konfigurointi
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#virheenjaljitys">
<span class="md-ellipsis">
      Virheenjäljitys
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="spring-boot-palvelun-julkaiseminen-rahti-ymparistossa">Spring Boot -palvelun julkaiseminen Rahti-ympäristössä</h1>
<h2 id="johdanto">Johdanto</h2>
<p>Tässä ohjeessa käydään läpi Spring-palvelun julkaisu Rahti-palvelussa. </p>
<p>Oletuksena on, että julkaistavassa palvelussa on Spring-palvelin sekä relaatiotietokanta. Julkaisu tehdään seuraavassa esimerkissä vaiheittain:</p>
<ol>
<li>Rahti-projektin luonti</li>
<li>Tietokantapalvelun luonti</li>
<li>Spring palvelimen julkaisu ilman ulkoista tietokantaa</li>
<li>Spring-palvelimen konfigurointi käyttämään ulkoista tietokantapalvelua</li>
</ol>
<h2 id="rahti-projektin-luonti">Rahti-projektin luonti</h2>
<div class="mermaid">flowchart LR
  classDef highlight fill:#ffe2ff,stroke:#996d99,stroke-width:3px;

  step1[Rahti-projektin luonti]
  step2[Tietokantapalvelun luonti]
  step3[Spring Boot -palvelimen julkaisu]
  step4[Tietokannan konfigurointi]

  step1:::highlight--&gt;step2
  step2--&gt;step3
  step3--&gt;step4
</div>
<p>Jotta Rahti-palvelua voi käyttää, pitää sen olla otettuna käyttöön MyCSC projektissa ja itse Rahti-palveluun pitää olla määriteltynä Rahti-projekti. </p>
<p>Kirjaudu rahtipalveluun osoitteessa <a href="https://rahti.csc.fi:8443">https://rahti.csc.fi:8443</a> käyttämällä Haka-kirjautumista. Kirjautumisen jälkeen palvelun etusivu näyttää tältä:</p>
<p><img alt="" src="../img/rahti_portal.png"/></p>
<p>Lisää itsellesi Rahti-projekti painamalla ’Create Project’ painiketta näkymän oikeasta yläreunasta. Anna projektille kuvaava nimi.</p>
<p><img alt="" src="../img/rahti_create_project.png"/></p>
<p>MyCSC:n projektinäkymässä näkyvä projektinumero tulee mainita Rahti-projektin kuvauskentässä projektia luotaessa. Tällä mekanismilla palvelun käytöstä syntyneet kulut kohdennetaan määriteltyyn MyCSC projektiin.</p>
<p>Kirjaa projektinumero projektin kommenttikenttään seuraavasti:</p>
<pre><code>csc_project:\&lt;projektinumero&gt;
</code></pre>
<p>Korvaa <em>\<projektinumero></projektinumero></em> oman MyCSC projektisi numerosarjalla.</p>
<p>Kun painat <em>Create</em>, luodaan Rahti-projekti, johon voidaan määritellä tarvittavia palveluja ja resursseja.</p>
<p>Rahti-projektit ovat henkilökohtaisia, eikä oletuksena näy muille. Projektiin kuitenkin mahdollista lisätä muita käyttäjiä heidän CSC tunnuksellaan <em>Resources/Membership</em>-asetuksen kautta.</p>
<p><img alt="" src="../img/rahti_add_member.png"/></p>
<p>Opiskelija voi halutessaan lisätä esimerkiksi kurssin opettajan omaan projektiinsa.</p>
<h3 id="openshift-komentorivityokalun-asennus">Openshift-komentorivityökalun asennus</h3>
<p>Red Hat tarjoaa työkalun nimeltään <code>oc</code> OpenShift ympäristön hallintaan komentoriviltä käsin. Linkki <code>oc</code>-työkalun lataamiseen löytyy Rahti-palvelun hallintanäkymästä.</p>
<p><img alt="" src="../img/rahti_commandline_tools.png"/></p>
<p>Linkistä avautuvalta sivustolta voi ladata omalle käyttöjärjestelmälle soveltuvan version. Linkeistä latautuu yksittäinen, suoritettava tiedosto nimeltään <code>oc</code>. Kyseisen tiedoston tulee löytyä käyttöjärjestelmän polusta (esim. Windows-ympäristön <code>PATH</code>-muuttujan määrittämässä sijainnissa) tai sen Spring-sovelluksen hakemistosta, mistä komentoja suoritetaan.</p>
<p>Jatkossa oletetaan, että <code>oc</code>-työkalu on asennettu polkuun. </p>
<h5 id="asennus-windows-ymparistossa">Asennus Windows-ympäristössä</h5>
<p>Kopioi <code>oc.exe</code> johonkin hakemistoon koneellasi (esimerkissä <code>c:\openshift\CLI</code>) ja lisää hakemisto polkuun.</p>
<pre><code class="language-powershell">$Path = [Environment]::GetEnvironmentVariable("PATH", "User") + [IO.Path]::PathSeparator + "C:\openshift\CLI"
[Environment]::SetEnvironmentVariable( "Path", $Path, "User" )
</code></pre>
<h4 id="rahti-palveluun-kirjautuminen-komentorivilla">Rahti-palveluun kirjautuminen komentorivillä</h4>
<p>Jotta <code>oc</code>-komentoja voi antaa, on kirjauduttava Rahti-palveluun komentorivin kautta. </p>
<p>Kirjautumiskomennon saa web käyttöliittymänäkymän oikeasta yläkulmasta <em>oma nimi</em> ja sen alta avautuvasta valikosta <em>Copy Login Command</em>.</p>
<p><img alt="" src="../img/rahti_copy_login_command.png"/></p>
<p>Liitä komento leikepöydältä paikallisen koneesi komentoriville ja suorita se projektin juurihakemistossa.  </p>
<p>Huom! Jos <code>oc</code>-komento ei ole polussa, voi olla tarpeen antaa komennonlle myös polku, esim.</p>
<pre><code class="language-bash">./oc login https://rahti.csc.fi:8443 -token=...
</code></pre>
<h2 id="tietokantapalvelun-luominen">Tietokantapalvelun luominen</h2>
<div class="mermaid">flowchart LR
  classDef highlight fill:#ffe2ff,stroke:#996d99,stroke-width:3px;

  step1[Rahti-projektin luonti]
  step2[Tietokantapalvelun luonti]
  step3[Spring Boot -palvelimen julkaisu]
  step4[Tietokannan konfigurointi]

  step1--&gt;step2
  step2:::highlight--&gt;step3
  step3--&gt;step4
</div>
<p>Rahti-projektiin voi lisätä esivalmisteltuja kontteja <em>Browse Catalog</em>-näkymästä:</p>
<p><img alt="" src="../img/rahti_add_service.png"/></p>
<p><img alt="" src="../img/rahti_browse_catalog.png"/></p>
<p>Tässä esimerkissä käytetään MySQL-vaihtoehtoa. </p>
<p><em>Huom! Tarjolla olevat Ephemeral-versiot tietokantapalveluista käyttävät pelkästään väliaikaista tallennuskapasiteettia ja kaikki mahdolliset muutokset mm. tietokantaan häviävät samalla, kun kontin suoritus loppuu. Pysyvää tallennusta varten tulee valita "tavallinen" tietokantapalvelukontti ja sille dedikoitu Persistent Volume Claim (PVC) -tallennustila.</em></p>
<p>Etene luontivelhon näkymässä ’Next’ painikkeella konfigurointikohtaan ja täytä kontille haluamasi asetukset. Asetuksista kannattaa täydentää ainakin:
-   <strong>Database Service Name</strong>: Tietokantapalvelun nimi. Tällä nimellä muut kontit löytävät palvelun.
-   <strong>MySQLConnection Username</strong>: Käyttäjätunnus sql-palvelimelle kirjautumiseen.
-   <strong>MySQL Connection Password</strong>: Salasana sql-palvelimelle kirjautumiseen.
-   <strong>MySQL Database Name</strong>. Luotavan tietokannan nimi.</p>
<p><img alt="" src="../img/mysql_configuration_dialog.png"/></p>
<p>Luontivelho tarjoaa mahdollisuuden luoda tietokannan luonnin yhteydessä salaisuustiedosto (<em>secret</em>), johon talletetaan tietokannan konfiguraatiotiedot. </p>
<p>Salaisuus kannattaa luoda, sillä sitä käyttäen luottamuksellisia konfiguraatiotietoja ei tarvitse tallettaa versionhallintaan, eikä niitä tarvitse lainkaan käsitellä suoraan vaan ne voidaan tarvittaessa lukea salaisuustiedostosta.</p>
<p><img alt="" src="../img/mysql_create_secret.png"/></p>
<p>Salaisuudet (ja muut vastaavat resurssit) löytyvät Rahti-palvelun web-käyttöliittymästä <em>Resources</em>-valikon alta.</p>
<p><img alt="" src="../img/rahti_resources_secret.png"/></p>
<h2 id="spring-boot-palvelimen-julkaisu">Spring Boot -palvelimen julkaisu</h2>
<div class="mermaid">flowchart LR
  classDef highlight fill:#ffe2ff,stroke:#996d99,stroke-width:3px;

  step1[Rahti-projektin luonti]
  step2[Tietokantapalvelun luonti]
  step3[Spring Boot -palvelimen julkaisu]
  step4[Tietokannan konfigurointi]

  step1--&gt;step2
  step2--&gt;step3
  step3:::highlight--&gt;step4
</div>
<p>Seuraavassa käydään läpi Spring Boot -palvelimen julkaisu ilman ulkoista tietokantaa.</p>
<p>Tietokannan konfigurointi käsitellään seuraavassa luvussa.</p>
<h3 id="julkaisu-yksityisesta-github-repositoriosta">Julkaisu yksityisestä GitHub-repositoriosta</h3>
<p>Jotta palvelun julkaisu voidaan automatisoida, sen lähdekoodien on oltava Rahti-palvelun build-työkalujen luettavissa. </p>
<p>Julkiseen GitHub-repositorioon lukuoikeus on kaikilla, siihen ei tarvita eri toimenpiteitä. Yksityisestä repositoriosta julkaisemista varten pitää lukuoikeus järjestää erikseen.</p>
<p>Julkaisua varten kannattaa luoda uusi SSH-avainpari juuri tätä projektia ja repositoriota varten. Henkilökohtaista SSH-avainta ei oel tarkoituksenmukaista käyttää julkaisuun, sillä julkaisuun tarvitaan yksityinen SSH-avain.</p>
<p>Luo sopivaan hakemistoon projektin ulkopuolella uusi avainpari. Salasanaa ei pidä määrittää.</p>
<pre><code class="language-bash">ssh-keygen -C "rahti-build@repo-url" -f id_rahti_build -N=""
</code></pre>
<ul>
<li><code>-C</code> lisää  avaintiedostoon kommentin, josta selviää, mikä avain on kyseessä, tässä <code>rahti-build@repo-url</code></li>
<li><code>-f</code> määrittää tiedostonimen, tässä <code>id_rahti_build</code></li>
<li><code>-N</code> määrittää, että ei käytetä salasanaa</li>
</ul>
<p>Lisää julkinen avain GitHub-repositorioon GitHubin käyttöliittymässä. Esimerkissä luodussa avainparissa julkinen avain on tiedostossa nimeltä <code>id_rahti_build.pub</code>.</p>
<p><img alt="" src="../img/github_add_deploy_key_ui.png"/></p>
<p><em>Title</em> on GitHubin käyttöliittymässä näkyvä nimi avaimelle. Julkaisuun ei tarvita kirjoitusoikeuksia. </p>
<p>Lisää yksityinen SSH-avain projektiin luomalla sitä varten salaisuus. Esimerkissä salaisuuden nimi on  <code>id-rahti-build</code> ja yksityinen avain on tiedostossa <code>id_rahti_build</code>.</p>
<pre><code class="language-bash">oc create secret generic id-rahti-build --from-file=ssh-privatekey=id_rahti_build --type=kubernetes.io/ssh-auth
</code></pre>
<p>Avainsalaisuus pitää vielä liittää Rahdin builder-palveluun</p>
<pre><code class="language-bash">oc secrets link builder id-rahti-build
</code></pre>
<h3 id="julkaisu-source-to-image-tyokaluilla">Julkaisu Source-to-Image-työkaluilla</h3>
<p>Projekti voidaan julkaista repositoriosta Source-to-Image-työkaluilla (S2I), jolloin kaikki tarvittavat resurssit luodaan automaattisesti ja saadaan valmis deployment-konfiguraatio.</p>
<p>Seuraavassa esimerkissä käydään läpi sovelluksen julkaisu S21-työkaluja käyttäen. Kaikki komennot tehdään komentoriviltä.</p>
<p>Luo ensin Rahti-projekti, kirjaudu Rahti-palveluun komentorivillä ja aseta luomasi projekti aktiiviseksi.</p>
<pre><code class="language-bash">oc project myproject
</code></pre>
<p>S2I-työkalut tarvitsevat pääsyn projektin repositorioon. </p>
<p>Jos repositorio on julkinen, voit luoda projektiin sovelluksen (<em>application</em>) komennolla:</p>
<pre><code class="language-bash">oc new-app fabric8/s2i-java~&lt;repository-URL&gt;#&lt;branch-name&gt;
</code></pre>
<ul>
<li><code>fabric8/s2i-java</code> on S2I-työkalulevykuva.</li>
<li><code>&lt;repositorio-URL&gt;</code> on osoite, josta repositorion voi kloonata</li>
<li><code>&lt;branch-name&gt;</code> on haara, josta julkaistaan.</li>
</ul>
<p>Jos repositorio on yksityinen, on Rahti-projektille järjestettävä pääsy luvun <a href="#julkaisu-yksityisestä-github-repositoriosta">Julkaisu yksityisestä GitHub-repositoriosta</a> ohjeiden mukaisesti. Sovelluksen luonnissa on annettava lisäksi tieto tarvittavasta SSH-avaimesta:</p>
<pre><code class="language-bash">oc new-app fabric8/s2i-java~&lt;repository-URL&gt;#&lt;branch-name&gt; --source-secret=&lt;github-creds-secret-name&gt;
</code></pre>
<ul>
<li><code>&lt;github-creds-secret-name&gt;</code> on salaisuus, joka sisältää yksityisen SSH-avaimen</li>
</ul>
<p>Tuloksena syntyy build config ja build käynnistyy. Voit seurata buildin etenemistä web-käyttöliittymässä.</p>
<p>Kun julkaisu on onnistunut, projektiin on ilmaantunut deployment-konfiguraatio sekä toivottavasti käynnissä oleva palvelu. </p>
<p>Tämän jälkeen ov vielä avattava palvelulle reitti (<em>route</em>), jolla palveluun pääsee internetistä. Sen voi tehdä komennolla <code>oc expose service</code>.</p>
<pre><code class="language-bash">oc expose service &lt;service-name&gt;
</code></pre>
<ul>
<li><code>&lt;service-name&gt;</code> on palvelun nimi</li>
</ul>
<p>Oletusarvoisesti luodaan salaamaton http-reitti. Jos halutaan https-pääsy, on se konfiguroitava erikseen, ks. luku <a href="#https-konfigurointi">HTTPS-konfigurointi</a></p>
<h3 id="julkaisu-dockerfilen-perusteella">Julkaisu Dockerfile:n perusteella</h3>
<p>Lisää Spring Boot projektin juureen tiedosto <code>Dockerfile</code>, jonka sisältö on seuraava:</p>
<pre><code class="language-dockerfile">FROM eclipse-temurin:17-jdk-focal as builder
WORKDIR /opt/app
COPY .mvn/ .mvn
COPY mvnw pom.xml ./
RUN chmod +x ./mvnw
RUN ./mvnw dependency:go-offline
COPY ./src ./src
RUN ./mvnw clean install -DskipTests 
RUN find ./target -type f -name '*.jar' -exec cp {} /opt/app/app.jar \; -quit

FROM eclipse-temurin:17-jre-alpine
COPY --from=builder /opt/app/*.jar /opt/app/
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "/opt/app/app.jar" ]
</code></pre>
<p>Määritys on laadittu yleiskäyttöiseksi, sen pitäisi toimia missä tahansa Spring Boot -projektissa sellaisenaan.</p>
<p>Jos repositorio on julkinen, voit luoda projektiin sovelluksen (<em>application</em>) komennolla:</p>
<pre><code class="language-bash">oc new-app &lt;repository-URL&gt;#&lt;branch-name&gt;
</code></pre>
<ul>
<li><code>&lt;repository-URL&gt;</code> on osoite, josta repositorion voi kloonata</li>
<li><code>&lt;branch-name&gt;</code> on haara, josta julkaistaan.</li>
</ul>
<p>Jos repositorio on yksityinen, on Rahti-projektille järjestettävä pääsy luvun <a href="#julkaisu-yksityisestä-github-repositoriosta">Julkaisu yksityisestä GitHub-repositoriosta</a> ohjeiden mukaisesti. Sovelluksen luonnissa on annettava lisäksi tieto tarvittavasta SSH-avaimesta:</p>
<pre><code class="language-bash">oc new-app &lt;repository-URL&gt;#&lt;branch-name&gt; --source-secret=github-ticketguru
</code></pre>
<ul>
<li><code>&lt;github-creds-secret-name&gt;</code> on salaisuus, joka sisältää yksityisen SSH-avaimen</li>
</ul>
<p>Tuloksena syntyy build config ja build käynnistyy. Voit seurata buildin etenemistä web-käyttöliittymässä.</p>
<p>Kun julkaisu on onnistunut, projektiin on ilmaantunut deployment-konfiguraatio sekä toivottavasti käynnissä oleva kontti.</p>
<p>Vielä on luotava palvelu (<em>service</em>):</p>
<pre><code class="language-bash">oc expose dc/&lt;deployment-config-name&gt; --port=8080
</code></pre>
<ul>
<li><code>&lt;deployment-config-name&gt;</code> on sovelluksen deployment config-nimi, sen voi tarkistaa web-käyttöliittymästä</li>
</ul>
<p>Service on luotu. tarvitaan vielä reitti:</p>
<pre><code class="language-bash">oc expose service &lt;service-name&gt;
</code></pre>
<ul>
<li><code>&lt;service-name&gt;</code> on äsken luodun palvelun nimi, oletusarvoisesti sama kuin <deployment-config-name></deployment-config-name></li>
</ul>
<p>Tällä syntyy reittikin, ja palvelu on julkaistu verkkoon HTTP-protokollalla. Jos halutaan https-pääsy, on se konfiguroitava erikseen, ks. luku <a href="#https-konfigurointi">HTTPS-konfigurointi</a></p>
<h3 id="julkaisu-paikallisesta-hakemistosta-jkube-openshift-maven-pluginilla">Julkaisu paikallisesta hakemistosta JKube OpenShift Maven pluginilla</h3>
<p>Eclipse JKube on kokoelma lisäosia ja kirjastoja, joiden avulla helpotetaan Java-ohjelmistojen kontittamista ja julkaisua OpenShift konttipalveluun. JKube OpenShift Maven pluginilla voidaan julkaista sovellus kehitysympäristösta suoraan paikallisesta hakemistosta (siis ei GitHub-repositoriosta). Tätä julkaisua ei voi samalla tavoin automatisoida kuin GitHubista tehtäviä julkaisuja.</p>
<p>Lisäosan käyttöönotto on suoraviivaista: Lisää Spring Boot projektin pom.xml tiedostoon JKube-lisäosan määritys:</p>
<pre><code class="language-xml">&lt;build&gt;
    &lt;plugins&gt;

        &lt;plugin&gt;
            &lt;groupId&gt;org.eclipse.jkube&lt;/groupId&gt;
            &lt;artifactId&gt;openshift-maven-plugin&lt;/artifactId&gt;
        &lt;/plugin&gt;

    &lt;/plugins&gt;
&lt;/build&gt;
</code></pre>
<p>Kirjaudu rahti-palveluun komentorivin kautta.Tämän jälkeen julkaisu voidaan tehdä maven -komennolla:</p>
<pre><code class="language-bash">./mvnw package oc:build oc:resource oc:apply
</code></pre>
<p>Komento valmistelee Java projektin, luo ja alustaa OpenShift ympäristöön soveltuvan kontin ja lataa kontin suoritukseen OpenShift ympäristöön.</p>
<p>Komennon päättymisen jälkeen Rahti-projektin Overview-näkymästä voit saada tietoa julkaisun tilasta ja onnistumisesta, sekä löydät julkaistun palvelun URL-osoitteen.</p>
<p><img alt="" src="../img/rahdit_project_overview_published.png"/></p>
<h3 id="buildin-kaynnistaminen">Buildin käynnistäminen</h3>
<p>Julkaisun jälkeen uusi julkaisu voidaan käynnistää manuaalisesti web-käyttöliittymästä tai komentorivillä <code>oc</code>-komennolla.  </p>
<pre><code class="language-bash">oc start-build &lt;build-config-name&gt;
</code></pre>
<ul>
<li><code>&lt;build-config-name&gt;</code> on oletusarvoisesti sama kuin <code>&lt;deployment-config-name&gt;</code></li>
</ul>
<p>Build voidaan myös automatisoida tapahtumaan aina, kun GitHub-repositorioon pusketaan uusi versio lähdekoodista</p>
<h4 id="buildin-automatisointi">Buildin automatisointi</h4>
<p>Jos sovellukselle on <em>build config</em>, jolla julkaisu tehdään GitHub-repositoriosta, voidaan build konfiguroida käynnistymään automaattisesti, kun repositorioon pusketaan uutta koodia.</p>
<p>Uusi build liipaistaan määrittämällä GitHub-repositorioon <em>webhook</em>, jota repositorio kutsuu aina, kun uusia muutoksia pusketaan.</p>
<p>Webhook-URL löytyy Rahti-palvelun käyttöliittymässä kohdata <em>Builds</em>.</p>
<p><img alt="" src="../img/rahti_find_webhook_url.png"/></p>
<p>Kopioi URL ja lisää se Github-repositorioon GitHubin web-käyttöliittymän kohdassa <em>Settings/Webhooks/Add webhook</em>.</p>
<p><img alt="" src="../img/github_add_webhook_ui.png"/></p>
<p>Content type-asetuksen tulee olla <code>application/json</code>.</p>
<h2 id="spring-boot-palvelimen-konfigurointi-kayttamaan-ulkoista-tietokantapalvelua">Spring Boot -palvelimen konfigurointi käyttämään ulkoista tietokantapalvelua</h2>
<div class="mermaid">flowchart LR
  classDef highlight fill:#ffe2ff,stroke:#996d99,stroke-width:3px;

  step1[Rahti-projektin luonti]
  step2[Tietokantapalvelun luonti]
  step3[Spring Boot -palvelimen julkaisu]
  step4[Tietokannan konfigurointi]

  step1--&gt;step2
  step2--&gt;step3
  step3--&gt;step4:::highlight
</div>
<p>Seuraavassa esimerkissä konfiguroidaan Spring Boot -palvelin käyttämään projektiin luotua tietokantapalvelua.</p>
<p>Esimerkissä palvelimessa käytettävän tietokannan asetukset hallitaan käyttämällä Spring-profiileja: tietokantakonfiguraatiota varten määritellään oma profiili, joka määritellään käyttöön julkaisuympäriristössä.</p>
<h3 id="julkaisuprofiilin-luonti-spring-projektiin">Julkaisuprofiilin luonti Spring-projektiin</h3>
<p>Profiili voidaan määritellä laatimalla projektiin profiilikohtainen <code>application.properties</code>-määritys. Sen nimeksi tulee asettaa <code>application-&lt;profiilinimi&gt;.properties</code>. Jos esimerkiksi profiilin nimeksi valitaan <code>rahti</code>, tiedoston nimi on <code>application-rahti.properties</code>.</p>
<p>Profiilikohtaiset asetukset luetaan globaalien asetusten lisäksi. Näin esim. julkaisukonfiguraatioparametrit voidaan määritellä jokaista julkaisuympäristöä varten eri tiedostoihin.</p>
<p>Seuraavassa esimerkissä käytetään palvelimen ajoympäristöstä luettavia ympäristömuuttuja-arvoja. Näin julkaisuympäristön konfiguraatioparametreja ei tarvitse viedä versionhallintaan.</p>
<p>Rahti-projektiin luotavat kontit saavat projektiin luodun tietokantapalvelun tiedot ajoympärisöön määritetyistä ympäristömuuttujista, joiden nimi muodostetaan tietokantapalvelun nimen perusteella seuraavasti:</p>
<pre class="no-copy"><code class="language-yaml">  &lt;tietokantapalvelun nimi&gt;_SERVICE_HOST
  &lt;tietokantapalvelun nimi&gt;_SERVICE_PORT
</code></pre>
<p>Voit avata kontin Terminal-näkymän ja tarkastella ympäristömuuttujia <code>env</code> komennolla. Alla olevassa kuvassa ympäristömuuttujista on lsitattu muuttujat, jotka kertoo tietokantapalvelun, jonka nimi on <code>mysql-service</code>, tiedot muille Rahti-projektin konteille.</p>
<p><img alt="" src="../img/rahti_pod_env_example.png"/></p>
<p>Esimerkki profiilimääritystiedoston sisällöstä, jos tietokantapalvelun nimeksi on asetettu <code>db-service</code>:</p>
<pre><code>spring.datasource.url=jdbc:mysql://${DB_SERVICE_SERVICE_HOST}:${DB_SERVICE_SERVICE_PORT}/${DB_NAME}
spring.datasource.username=${DB_USER}
spring.datasource.password=${DB_PASSWORD}
spring.jpa.show-sql=true
spring.jpa.generate-ddl=true
spring.jpa.hibernate.ddl-auto=update
</code></pre>
<p>Huom: Tietokantapalvelinta kytkettäessä muihin kontteihin, on tärkeää käyttää muuttujanimiä eikä esim. IP-osoitetta suoraan. IP-osoitteet voivat muuttua esimerkiksi kontin uudelleen käynnistymisen yhteydessä</p>
<h3 id="ymparistomuuttujien-asettaminen">Ympäristömuuttujien asettaminen</h3>
<p>Profiiliin määritellyt ympäristömuuttujat pitää vielä asettaa. Voit määritellä käynnistettävälle kontille ympäristömuuttujia Rahti-palvelun web-käyttöliittymässä kohdassa <em>Applications/Deployments</em>:</p>
<p><img alt="" src="../img/rahti_deployment_config_env_variables.png"/></p>
<p>Ympäristömuuttujan arvon voidaan määritellä suoraan tai valita sen jostain projektiin luodusta salaisuudesta. </p>
<p>Ylläolevassa esimerkissä MySQL-tietokannan tietokantakäyttäjän nimi <code>DB_USER</code> ja salasana <code>DB_PASSWORD</code> sekä tietokannan nimi <code>DB_NAME</code> luetaan salaisuudesta, joka luotiin tietokantapalvelun lisäämisen yhteydessä. Aktiivisen profiilin asettavan ympäristömuuttujan arvo <code>SPRING_PROFILES_ACTIVE</code> annetaan suoraan.</p>
<p>Kun julkaisu seuraavan kerran tehdään, käynnistyvässä kontissa ympäristömuuttujat on määritelty.</p>
<h3 id="ymparistomuuttujien-asettaminen-jkube-openshift-maven-pluginia-kaytettaessa">Ympäristömuuttujien asettaminen JKube OpenShift Maven pluginia käytettäessä</h3>
<p>Koska OpenShift Maven plugin yliajaa kaikki web-käyttöliittymässä tehdyt konttiasetukset, on sitä käytettäessä määritykset tehtävä pluginin määritystiedostossa.</p>
<p>Tarkista Rahti-palvelun hallintakäyttöliittymästä tietokannan luonnin yhteydessä luodun salaisuuden nimi. Tässä esimerkissä se on <code>mysql-secret</code>. </p>
<p>Lisää Spring sovelluksen hakemistorakenteeseen <code>src/main/jkube</code> tiedosto nimeltään <code>deployment.yml</code>.</p>
<pre><code>spec:
  template:
    spec:
      containers:
        - env:
            - name: MYSQL_USER
              valueFrom:
                secretKeyRef:
                  key: database-user
                  name: mysql-secret
            - name: MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: database-password
                  name: mysql-secret
            - name: MYSQL_DATABASE
              valueFrom:
                secretKeyRef:
                  key: database-name
                  name: mysql-secret
            - name: SPRING_PROFILES_ACTIVE
              value: rahti
</code></pre>
<p>Parametrien selitykset:
- <code>name</code> on asetettavan ympäristömuuttujan nimi
- <code>valueFrom.secretKeyRef.name</code> määrittää, minkä nimisestä salaisuudesta arvo luetaan. Vaihda tähän omasta ympäristöstäsi oikea salaisuuden nimi.
- <code>valueFrom.secretKeyRef.key</code> määrittää, mistä salaisuuden kentästä arvo luetaan.
- Lopuksi asetaan ympäristömuuttujan SPRING_PROFILES_ACTIVE arvoksi halutun profiilin nimi. Käytettävä Spring-profiili voidaan asettaa ympäristömuuttujalla SPRING_PROFILES_ACTIVE.</p>
<p>Huomaa, että tiedostomuoto on YAML. Sen rakenteeseen on tarvittaessa hyvä hakea vinkkiä web-käyttöliittymästä valitsemalla tietokantapodin valikosta <em>Edit YAML</em>.</p>
<p>Suorita uudelleen komento </p>
<pre><code> ./mvnw package oc:build oc:resource oc:apply
</code></pre>
<p>Rahti-projektin <em>Overview</em>-näkymässä voi seurata julkaisun etenemistä. Onnistuneen julkaisun jälkeen näkymässä näkyy, että sekä sovelluspalvelinkontti(Spring Boot-palvelin) että tietokantapalvelinkontti ovat käynnissä.</p>
<p><img alt="" src="../img/rahti_publish_success.png"/></p>
<h2 id="https-konfigurointi">HTTPS-konfigurointi</h2>
<p>Julkaistu palvelu tarjotaan oletusarvoisesti vain HTTP-protokollalla. Palvelu voidaan konfiguroida tarjottavaksi myös HTTPS-protokollalla tai pelkästään HTTPS-protokollalla.</p>
<p>Konfiguroinnin voi tehdä komentorivillä komennolla </p>
<pre><code class="language-bash">oc create route edge --service=&lt;service-name&gt;
</code></pre>
<p>Web-käyttöliittymässä määritys tehdään Rahti-sovelluksen Route-määrittelyssä.</p>
<p><img alt="" src="../img/rahti_routes.png"/></p>
<p><img alt="" src="../img/rahti_route_edit.png"/></p>
<p>Reitille voidaan konfiguroida TLS käyttöön. Jos sertifikaatin jättää määrittämättä, käytetään oletussertifikaattia. HTTP-liikenteen voi joko sallia, estää tai uudelleenohjata.</p>
<p><img alt="" src="../img/rahti_route_enable_tls.png"/></p>
<p>Lisätietoa: <a href="https://docs.csc.fi/cloud/rahti/networking/">Rahti Docs: Networking</a></p>
<h2 id="virheenjaljitys">Virheenjäljitys</h2>
<p>Käynnissä olevien konttien (<em>pod</em>) tietoja voidaan tarkastella Rahti-palvelun hallintaliittymässä.</p>
<p>Käynnissä olevat kontit löytyvät helposti Overview-näkymästä.</p>
<p><img alt="" src="../img/rahti_overview_pods_highlight.png"/></p>
<p>Lokeja voi tarkastella välilehdellä <em>Logs</em>:</p>
<p><img alt="" src="../img/rahti_pod_log.png"/></p>
<p>Konttiin saa pääteyhteyden välilehdellä <em>Terminal</em>:</p>
<p><img alt="" src="../img/rahti_pod_terminal.png"/></p>
<p>Konttiin saa ssh-yhteyden myös komentorivillä komennolla <code>oc rsh &lt;nimi&gt;</code>. Projektin kontit voi listata komennolla <code>oc get pods</code>.</p>
<pre><code class="language-bash">PS &gt; oc get pods
NAME                  READY     STATUS      RESTARTS   AGE
dbservice-1-p2smq     1/1       Running     0          4h
ticketguru-11-sbqhn   1/1       Running     0          1h
PS &gt; oc rsh ticketguru-11-sbqhn
~ $ 
</code></pre>
<p>Tietokantaa voi tarkastella tietokantajärjestelmän komentorivityökaluilla tietokantakontin pääteyhteydellä, esim. </p>
<pre><code class="language-bash">$ mysql -u dbuser -p dbname
</code></pre>
</article>
</div>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "navigation.tabs", "toc.integrate", "navigation.top"], "search": "../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Kopioitu leikep\u00f6yd\u00e4lle", "clipboard.copy": "Kopioi leikep\u00f6yd\u00e4lle", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "Ei t\u00e4sm\u00e4\u00e4vi\u00e4 dokumentteja", "search.result.one": "1 t\u00e4sm\u00e4\u00e4v\u00e4 dokumentti", "search.result.other": "# t\u00e4sm\u00e4\u00e4v\u00e4\u00e4 dokumenttia", "search.result.placeholder": "Kirjoita aloittaaksesi haun", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../assets/javascripts/bundle.6c14ae12.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
mermaid.initialize({});</script></body>
</html>