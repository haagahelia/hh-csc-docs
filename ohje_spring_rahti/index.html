
<!DOCTYPE html>

<html class="no-js" lang="fi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../ohje_opettaja/" rel="prev"/>
<link href="../ohje_react_rahti/" rel="next"/>
<link href="../assets/favicon-192x192.png" rel="icon"/>
<meta content="mkdocs-1.5.3, mkdocs-material-9.4.10" name="generator"/>
<title>Spring Boot-palvelun julkaisu - CSC-palvelut Haaga-Heliassa</title>
<link href="../assets/stylesheets/main.fad675c6.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../stylesheets/extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#spring-boot-palvelun-julkaiseminen-rahti-ymparistossa">
          Hyppää sisältöön
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="CSC-palvelut Haaga-Heliassa" class="md-header__button md-logo" data-md-component="logo" href=".." title="CSC-palvelut Haaga-Heliassa">
<img alt="logo" src="../assets/haaga-helia.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            CSC-palvelut Haaga-Heliassa
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Spring Boot-palvelun julkaisu
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Hae" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Hae" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="..">
        
  
    
  
  Yleistä

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../ohje_opettaja/">
        
  
    
  
  Ohjeet opettajalle

      </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="./">
        
  
    
  
  Spring Boot-palvelun julkaisu

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../ohje_react_rahti/">
        
  
    
  
  React-sovelluksen julkaisu

      </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="CSC-palvelut Haaga-Heliassa" class="md-nav__button md-logo" data-md-component="logo" href=".." title="CSC-palvelut Haaga-Heliassa">
<img alt="logo" src="../assets/haaga-helia.png"/>
</a>
    CSC-palvelut Haaga-Heliassa
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="..">
<span class="md-ellipsis">
    Yleistä
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ohje_opettaja/">
<span class="md-ellipsis">
    Ohjeet opettajalle
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Spring Boot-palvelun julkaisu
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Spring Boot-palvelun julkaisu
  </span>
</a>
<nav aria-label="Sisällysluettelo" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Sisällysluettelo
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#johdanto">
<span class="md-ellipsis">
      Johdanto
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#rahti-projektin-luonti">
<span class="md-ellipsis">
      Rahti-projektin luonti
    </span>
</a>
<nav aria-label="Rahti-projektin luonti" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#jasenten-lisaaminen-rahti-projektiin">
<span class="md-ellipsis">
      Jäsenten lisääminen Rahti-projektiin
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#openshift-komentorivityokalun-asennus">
<span class="md-ellipsis">
      Openshift-komentorivityökalun asennus
    </span>
</a>
<nav aria-label="Openshift-komentorivityökalun asennus" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#asennus-windows-ymparistossa">
<span class="md-ellipsis">
      Asennus Windows-ympäristössä
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#rahti-palveluun-kirjautuminen-komentorivilla">
<span class="md-ellipsis">
      Rahti-palveluun kirjautuminen komentorivillä
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tietokantapalvelun-luominen">
<span class="md-ellipsis">
      Tietokantapalvelun luominen
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#spring-boot-palvelimen-julkaisu">
<span class="md-ellipsis">
      Spring Boot -palvelimen julkaisu
    </span>
</a>
<nav aria-label="Spring Boot -palvelimen julkaisu" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#sovelluksen-luonti-repositoriosta">
<span class="md-ellipsis">
      Sovelluksen luonti repositoriosta
    </span>
</a>
<nav aria-label="Sovelluksen luonti repositoriosta" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#sovellusprojektin-sijainti-repositoriossa">
<span class="md-ellipsis">
      Sovellusprojektin sijainti repositoriossa
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#yksityisen-repositorion-kaytto">
<span class="md-ellipsis">
      Yksityisen repositorion käyttö
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sovelluksen-luonti">
<span class="md-ellipsis">
      Sovelluksen luonti
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#buildin-kaynnistaminen">
<span class="md-ellipsis">
      Buildin käynnistäminen
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#buildin-automatisointi">
<span class="md-ellipsis">
      Buildin automatisointi
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#spring-boot-palvelimen-konfigurointi-kayttamaan-ulkoista-tietokantapalvelua">
<span class="md-ellipsis">
      Spring Boot -palvelimen konfigurointi käyttämään ulkoista tietokantapalvelua
    </span>
</a>
<nav aria-label="Spring Boot -palvelimen konfigurointi käyttämään ulkoista tietokantapalvelua" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#julkaisuprofiilin-luonti-spring-projektiin">
<span class="md-ellipsis">
      Julkaisuprofiilin luonti Spring-projektiin
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ymparistomuuttujien-asettaminen">
<span class="md-ellipsis">
      Ympäristömuuttujien asettaminen
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#https-konfigurointi">
<span class="md-ellipsis">
      HTTPS-konfigurointi
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#virheenjaljitys">
<span class="md-ellipsis">
      Virheenjäljitys
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#projektin-uudelleenluonti">
<span class="md-ellipsis">
      Projektin uudelleenluonti
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#julkaisu-paikallisesta-hakemistosta-jkube-openshift-maven-pluginilla">
<span class="md-ellipsis">
      Julkaisu paikallisesta hakemistosta JKube OpenShift Maven pluginilla
    </span>
</a>
<nav aria-label="Julkaisu paikallisesta hakemistosta JKube OpenShift Maven pluginilla" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#ymparistomuuttujien-asettaminen-jkube-openshift-maven-pluginia-kaytettaessa">
<span class="md-ellipsis">
      Ympäristömuuttujien asettaminen JKube OpenShift Maven pluginia käytettäessä
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ohje_react_rahti/">
<span class="md-ellipsis">
    React-sovelluksen julkaisu
  </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="spring-boot-palvelun-julkaiseminen-rahti-ymparistossa">Spring Boot -palvelun julkaiseminen Rahti-ympäristössä</h1>
<h2 id="johdanto">Johdanto</h2>
<p>Tässä ohjeessa käydään läpi Spring-palvelun julkaisu Rahti-palvelussa. </p>
<p>Oletuksena on, että julkaistavassa palvelussa on Spring-palvelin sekä relaatiotietokanta. Julkaisu tehdään seuraavassa esimerkissä vaiheittain:</p>
<ol>
<li>Rahti-projektin luonti</li>
<li>Tietokantapalvelun luonti</li>
<li>Spring palvelimen julkaisu ilman ulkoista tietokantaa</li>
<li>Spring-palvelimen konfigurointi käyttämään ulkoista tietokantapalvelua</li>
</ol>
<h2 id="rahti-projektin-luonti">Rahti-projektin luonti</h2>
<div class="mermaid">flowchart LR
  classDef highlight fill:#ffe2ff,stroke:#996d99,stroke-width:3px;

  step1[Rahti-projektin luonti]
  step2[Tietokantapalvelun luonti]
  step3[Spring Boot -palvelimen julkaisu]
  step4[Tietokannan konfigurointi]

  step1:::highlight--&gt;step2
  step2--&gt;step3
  step3--&gt;step4</div>
<p>Jotta Rahti-palvelua voi käyttää, pitää sen olla otettuna käyttöön MyCSC projektissa ja itse Rahti-palveluun pitää olla määriteltynä Rahti-projekti. </p>
<p>Kirjaudu Rahti-palvelun web-käyttöliittymään osoitteessa <a href="https://rahti.csc.fi:8443">https://rahti.csc.fi:8443</a> CSC-tunnuksellasi. Kirjautumisen jälkeen palvelun etusivu näyttää tältä:</p>
<p><img alt="" src="../img/rahti_portal.png"/></p>
<p>Lisää itsellesi Rahti-projekti painamalla ’Create Project’ painiketta näkymän oikeasta yläreunasta. Anna projektille kuvaava nimi.</p>
<p><img alt="" src="../img/rahti_create_project.png"/></p>
<p>MyCSC:n projektinäkymässä näkyvä projektinumero tulee mainita Rahti-projektin kuvauskentässä projektia luotaessa. Tällä mekanismilla palvelun käytöstä syntyneet kulut kohdennetaan määriteltyyn MyCSC projektiin.</p>
<p>Kirjaa projektinumero projektin kommenttikenttään seuraavasti:
<div class="highlight"><pre><span></span><code>csc_project:&lt;projektinumero&gt;
</code></pre></div>
Korvaa <em>\<projektinumero></projektinumero></em> oman MyCSC projektisi numerosarjalla.</p>
<p>Kun painat <em>Create</em>, luodaan Rahti-projekti, johon voidaan määritellä tarvittavia palveluja ja resursseja.</p>
<h3 id="jasenten-lisaaminen-rahti-projektiin">Jäsenten lisääminen Rahti-projektiin</h3>
<p>Rahti-projektit ovat henkilökohtaisia, eivätkä ne oletusarvoisesti näy muille. Projektiin voidaan lisätä muita käyttäjiä heidän CSC-tunnuksillaan <em>Resources/Membership</em>-asetuksen kautta.</p>
<p><img alt="" src="../img/rahti_add_member.png"/></p>
<p>Voit Rahti-projektin omistajana näin lisätä projektitiimin jäsenet tai kurssin opettajan omaan projektiisi. </p>
<h3 id="openshift-komentorivityokalun-asennus">Openshift-komentorivityökalun asennus</h3>
<p>Red Hat tarjoaa työkalun nimeltään <code>oc</code> OpenShift ympäristön hallintaan komentoriviltä käsin. Linkki <code>oc</code>-työkalun lataamiseen löytyy Rahti-palvelun hallintanäkymästä.</p>
<p><img alt="" src="../img/rahti_commandline_tools.png"/></p>
<p>Linkistä avautuvalta sivustolta voi ladata omalle käyttöjärjestelmälle soveltuvan version. Linkeistä latautuu yksittäinen, suoritettava tiedosto nimeltään <code>oc</code>. Kyseisen tiedoston tulee löytyä käyttöjärjestelmän polusta (esim. Windows-ympäristön <code>PATH</code>-muuttujan määrittämässä sijainnissa) tai sen Spring-sovelluksen hakemistosta, mistä komentoja suoritetaan.</p>
<p>Jatkossa oletetaan, että <code>oc</code>-työkalu on asennettu polkuun. </p>
<h5 id="asennus-windows-ymparistossa">Asennus Windows-ympäristössä</h5>
<p>Kopioi <code>oc.exe</code> johonkin hakemistoon koneellasi (esimerkissä <code>c:\openshift\CLI</code>) ja lisää hakemisto polkuun.</p>
<div class="highlight"><pre><span></span><code><span class="nv">$Path</span> <span class="p">=</span> <span class="no">[Environment]</span><span class="p">::</span><span class="n">GetEnvironmentVariable</span><span class="p">(</span><span class="s2">"PATH"</span><span class="p">,</span> <span class="s2">"User"</span><span class="p">)</span> <span class="p">+</span> <span class="no">[IO.Path]</span><span class="p">::</span><span class="n">PathSeparator</span> <span class="p">+</span> <span class="s2">"C:\openshift\CLI"</span>
<span class="no">[Environment]</span><span class="p">::</span><span class="n">SetEnvironmentVariable</span><span class="p">(</span> <span class="s2">"Path"</span><span class="p">,</span> <span class="nv">$Path</span><span class="p">,</span> <span class="s2">"User"</span> <span class="p">)</span>
</code></pre></div>
<h3 id="rahti-palveluun-kirjautuminen-komentorivilla">Rahti-palveluun kirjautuminen komentorivillä</h3>
<p>Jotta <code>oc</code>-komentoja voi antaa, on kirjauduttava Rahti-palveluun komentorivin kautta. </p>
<p>Kirjautumiskomennon saa web käyttöliittymänäkymän oikeasta yläkulmasta <em>oma nimi</em> ja sen alta avautuvasta valikosta <em>Copy Login Command</em>.</p>
<p><img alt="" src="../img/rahti_copy_login_command.png"/></p>
<p>Liitä komento leikepöydältä paikallisen koneesi komentoriville ja suorita se projektin juurihakemistossa.  </p>
<p>Huom! Jos <code>oc</code>-komento ei ole polussa, voi olla tarpeen antaa komennonlle myös polku, esim.
<div class="highlight"><pre><span></span><code>./oc<span class="w"> </span>login<span class="w"> </span>https://rahti.csc.fi:8443<span class="w"> </span>-token<span class="o">=</span>...
</code></pre></div></p>
<h2 id="tietokantapalvelun-luominen">Tietokantapalvelun luominen</h2>
<div class="mermaid">flowchart LR
  classDef highlight fill:#ffe2ff,stroke:#996d99,stroke-width:3px;

  step1[Rahti-projektin luonti]
  step2[Tietokantapalvelun luonti]
  step3[Spring Boot -palvelimen julkaisu]
  step4[Tietokannan konfigurointi]

  step1--&gt;step2
  step2:::highlight--&gt;step3
  step3--&gt;step4</div>
<p>Rahti-projektiin voi lisätä esivalmisteltuja kontteja <em>Browse Catalog</em>-näkymästä:</p>
<p><img alt="" src="../img/rahti_add_service.png"/></p>
<p><img alt="" src="../img/rahti_browse_catalog.png"/></p>
<p>Tässä esimerkissä käytetään MySQL-vaihtoehtoa. </p>
<p><em>Huom! Tarjolla olevat Ephemeral-versiot tietokantapalveluista käyttävät pelkästään väliaikaista tallennuskapasiteettia ja kaikki mahdolliset muutokset mm. tietokantaan häviävät samalla, kun kontin suoritus loppuu. Pysyvää tallennusta varten tulee valita "tavallinen" tietokantapalvelukontti ja sille dedikoitu Persistent Volume Claim (PVC) -tallennustila.</em></p>
<p>Etene luontivelhon näkymässä ’Next’ painikkeella konfigurointikohtaan ja täytä kontille haluamasi asetukset. Asetuksista kannattaa täydentää ainakin:</p>
<ul>
<li><strong>Database Service Name</strong>: Tietokantapalvelun nimi. Tällä nimellä muut kontit löytävät palvelun.</li>
<li><strong>MySQLConnection Username</strong>: Käyttäjätunnus sql-palvelimelle kirjautumiseen.</li>
<li><strong>MySQL Connection Password</strong>: Salasana sql-palvelimelle kirjautumiseen.</li>
<li><strong>MySQL Database Name</strong>. Luotavan tietokannan nimi.</li>
</ul>
<p><img alt="" src="../img/mysql_configuration_dialog.png"/></p>
<p>Luontivelho tarjoaa mahdollisuuden luoda tietokannan luonnin yhteydessä salaisuustiedosto (<em>secret</em>), johon talletetaan tietokannan konfiguraatiotiedot. </p>
<p>Salaisuus kannattaa luoda, sillä sitä käyttäen luottamuksellisia konfiguraatiotietoja ei tarvitse tallettaa versionhallintaan, eikä niitä tarvitse lainkaan käsitellä suoraan vaan ne voidaan tarvittaessa lukea salaisuustiedostosta.</p>
<p><img alt="" src="../img/mysql_create_secret.png"/></p>
<p>Salaisuudet (ja muut vastaavat resurssit) löytyvät Rahti-palvelun web-käyttöliittymästä <em>Resources</em>-valikon alta.</p>
<p><img alt="" src="../img/rahti_resources_secret.png"/></p>
<h2 id="spring-boot-palvelimen-julkaisu">Spring Boot -palvelimen julkaisu</h2>
<div class="mermaid">flowchart LR
  classDef highlight fill:#ffe2ff,stroke:#996d99,stroke-width:3px;

  step1[Rahti-projektin luonti]
  step2[Tietokantapalvelun luonti]
  step3[Spring Boot -palvelimen julkaisu]
  step4[Tietokannan konfigurointi]

  step1--&gt;step2
  step2--&gt;step3
  step3:::highlight--&gt;step4</div>
<p>Seuraavassa käydään läpi Spring Boot -palvelimen julkaisu ilman ulkoista tietokantaa.</p>
<p>Tietokannan konfigurointi käsitellään seuraavassa luvussa.</p>
<p><strong>Huom!</strong> Jotta tässä luvussa käytettäviä <code>oc</code>-komentoja voi antaa, on ensin kirjauduttava Rahti-palveluun luvun <a href="#rahti-palveluun-kirjautuminen-komentorivilla">Rahti-palveluun kirjautuminen komentorivillä</a> ohjeiden mukaisesti.</p>
<p>Kirjaudu ensin Rahti-palveluun komentorivillä ja aseta luomasi projekti aktiiviseksi.</p>
<div class="highlight"><pre><span></span><code>oc<span class="w"> </span>project<span class="w"> </span>myproject
</code></pre></div>
<h3 id="sovelluksen-luonti-repositoriosta">Sovelluksen luonti repositoriosta</h3>
<p>Rahti-palvelun työkaluilla voidaan luoda sovelluksen julkaisuun tarvittavat resurssit repositorion sisällön perusteella automaattisesti. Resurssit voidaan luoda joko suoraan lähdekoodin perusteella (<em>Source-to_Image</em>, <em>S2I</em>) tai projektissa määritetyn Dockerfile:n perusteella. </p>
<p>Uusi sovellus voidaan luoda komentorivikomennolla <code>oc new-app</code>. Komennolle annetaan parametrina repositorio-osoite, josta projekti käydään hakemassa. </p>
<h4 id="sovellusprojektin-sijainti-repositoriossa">Sovellusprojektin sijainti repositoriossa</h4>
<p>Build-työkalut olettavat, että sovellusprojekti sijaitsee repositorion juurihakemistossa. Jos näin ei ole, voidaan projektihakemisto antaa valitsinparametrilla:</p>
<p><div class="highlight"><pre><span></span><code>--context-dir<span class="o">=</span>&lt;projektihakemisto&gt;
</code></pre></div>
- <code>&lt;projektihakemisto&gt;</code> on suhteellinen polku repositorion juuresta siihen hakemistoon, jossa sovellusprojekti sijaitsee, esim. <code>--context-dir=myproj</code>. </p>
<h4 id="yksityisen-repositorion-kaytto">Yksityisen repositorion käyttö</h4>
<p>Rahti-työkalut tarvitsevat pääsyn projektin repositorioon. Jos repositorio on julkinen, ei pääsyoikeuksia tarvitse erikseen määrittää.</p>
<p>Jos repositorio on yksityinen, on Rahti-projektille järjestettävä pääsy luvun <a href="#julkaisu-yksityisestä-github-repositoriosta">Julkaisu yksityisestä GitHub-repositoriosta</a> ohjeiden mukaisesti, ja annettavissa komennoissa on lisäksi annettava  tieto tarvittavasta SSH-avaimesta valitsimella </p>
<div class="highlight"><pre><span></span><code>--source-secret<span class="o">=</span>&lt;github-creds-secret-name&gt;
</code></pre></div>
<ul>
<li><code>&lt;github-creds-secret-name&gt;</code> on salaisuus, joka sisältää yksityisen SSH-avaimen.</li>
</ul>
<p>Tässä tapauksessa repositorion osoite pitää antaa SSH-muodossa, esim:</p>
<p><div class="highlight"><pre><span></span><code>git@github.com:&lt;user&gt;/&lt;repositorionimi&gt;.git
</code></pre></div>
<img alt="" src="../img/github_ssh_address.png"/></p>
<h4 id="sovelluksen-luonti">Sovelluksen luonti</h4>
<p>Seuraavissa esimerkeissä käydään läpi sovelluksen julkaisu molemmilla edellä mainituilla tavoilla. Kaikki komennot tehdään komentoriviltä. </p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio"><input id="__tabbed_1_2" name="__tabbed_1" type="radio"><div class="tabbed-labels"><label for="__tabbed_1_1">Dockerfilen perusteella</label><label for="__tabbed_1_2">Source-to-Image-työkaluilla</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>Lisää Spring Boot projektin juureen tiedosto <code>Dockerfile</code>, jonka sisältö on seuraava:</p>
<p><div class="highlight"><pre><span></span><code><span class="k">FROM</span><span class="w"> </span><span class="s">eclipse-temurin:17-jdk-focal</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">builder</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/opt/app</span>
<span class="k">COPY</span><span class="w"> </span>.mvn/<span class="w"> </span>.mvn
<span class="k">COPY</span><span class="w"> </span>mvnw<span class="w"> </span>pom.xml<span class="w"> </span>./
<span class="k">RUN</span><span class="w"> </span>chmod<span class="w"> </span>+x<span class="w"> </span>./mvnw
<span class="k">RUN</span><span class="w"> </span>./mvnw<span class="w"> </span>dependency:go-offline
<span class="k">COPY</span><span class="w"> </span>./src<span class="w"> </span>./src
<span class="k">RUN</span><span class="w"> </span>./mvnw<span class="w"> </span>clean<span class="w"> </span>install<span class="w"> </span>-DskipTests<span class="w"> </span>
<span class="k">RUN</span><span class="w"> </span>find<span class="w"> </span>./target<span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span>-name<span class="w"> </span><span class="s1">'*.jar'</span><span class="w"> </span>-exec<span class="w"> </span>cp<span class="w"> </span><span class="o">{}</span><span class="w"> </span>/opt/app/app.jar<span class="w"> </span><span class="se">\;</span><span class="w"> </span>-quit

<span class="k">FROM</span><span class="w"> </span><span class="s">eclipse-temurin:17-jre-alpine</span>
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder<span class="w"> </span>/opt/app/*.jar<span class="w"> </span>/opt/app/
<span class="k">EXPOSE</span><span class="w"> </span><span class="s">8080</span>
<span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">"java"</span><span class="p">,</span><span class="w"> </span><span class="s2">"-jar"</span><span class="p">,</span><span class="w"> </span><span class="s2">"/opt/app/app.jar"</span><span class="w"> </span><span class="p">]</span>
</code></pre></div>
Määritys on laadittu yleiskäyttöiseksi, sen pitäisi toimia missä tahansa Spring Boot -projektissa sellaisenaan.</p>
<p>Jos repositorio on julkinen, voit luoda projektiin sovelluksen (<em>application</em>) komennolla:
<div class="highlight"><pre><span></span><code>oc<span class="w"> </span>new-app<span class="w"> </span>&lt;repository-URL&gt;#&lt;branch-name&gt;
</code></pre></div>
- <code>&lt;repository-URL&gt;</code> on osoite, josta repositorion voi kloonata
- <code>&lt;branch-name&gt;</code> on haara, josta julkaistaan.</p>
<p>Jos repositorio on yksityinen, on komentoon lisättävä tieto käytettävästä SSH-avaimesta:</p>
<div class="highlight"><pre><span></span><code>oc<span class="w"> </span>new-app<span class="w"> </span>&lt;repository-URL&gt;#&lt;branch-name&gt;<span class="w"> </span>--source-secret<span class="o">=</span>github-ticketguru
</code></pre></div>
<p>Tuloksena syntyy build config ja build käynnistyy. Voit seurata buildin etenemistä web-käyttöliittymässä.</p>
<p>Kun julkaisu on onnistunut, projektiin on ilmaantunut deployment-konfiguraatio (<em>deployment configuration</em>), palvelu (<em>service</em>) sekä toivottavasti käynnissä oleva kontti.</p>
<p>Kun service on luotu. tarvitaan vielä reitti:</p>
<p><div class="highlight"><pre><span></span><code>oc<span class="w"> </span>expose<span class="w"> </span>service<span class="w"> </span>&lt;service-name&gt;
</code></pre></div>
- <code>&lt;service-name&gt;</code> on äsken luodun palvelun nimi, oletusarvoisesti sama kuin sovelluksen nimi. Sovelluksen palvelut voi katsoa web-käyttöliittymästä tai listata komennolla <code>oc get svc</code>.</p>
<p>Tällä syntyy reittikin, ja palvelu on julkaistu verkkoon HTTP-protokollalla. Jos halutaan https-pääsy, on se konfiguroitava erikseen, ks. luku <a href="#https-konfigurointi">HTTPS-konfigurointi</a></p>
</div>
<div class="tabbed-block">
<p>Jos repositorio on julkinen, voit luoda projektiin sovelluksen (<em>application</em>) komennolla:</p>
<p><div class="highlight"><pre><span></span><code>oc new-app registry.access.redhat.com/ubi8/openjdk-17:1.18-2~&lt;repository-URL&gt;#&lt;branch-name&gt;
</code></pre></div>
- <code>registry.access.redhat.com/ubi8/openjdk-17:1.18-2</code> on S2I-työkalulevykuva Java 17-sovelluksille
- <code>&lt;repositorio-URL&gt;</code> on osoite, josta repositorion voi kloonata
- <code>&lt;branch-name&gt;</code> on haara, josta julkaistaan.</p>
<p>Jos repositorio on yksityinen, on komentoon lisättävä tieto käytettävästä SSH-avaimesta:
<div class="highlight"><pre><span></span><code>oc new-app registry.access.redhat.com/ubi8/openjdk-17:1.18-2~&lt;repository-URL&gt;#&lt;branch-name&gt; --source-secret=&lt;github-creds-secret-name&gt;
</code></pre></div>
Tuloksena syntyy build config ja build käynnistyy. Voit seurata buildin etenemistä web-käyttöliittymässä.</p>
<p>Kun julkaisu on onnistunut, projektiin on ilmaantunut deployment-konfiguraatio sekä toivottavasti käynnissä oleva palvelu. </p>
<p>Tämän jälkeen on vielä avattava palvelulle reitti (<em>route</em>), jolla palveluun pääsee internetistä. Sen voi tehdä komennolla:</p>
<p><div class="highlight"><pre><span></span><code>oc<span class="w"> </span>expose<span class="w"> </span>service<span class="w"> </span>&lt;service-name&gt;
</code></pre></div>
- <code>&lt;service-name&gt;</code> on palvelun nimi</p>
<p>Oletusarvoisesti luodaan salaamaton http-reitti. Jos halutaan https-pääsy, on se konfiguroitava erikseen, ks. luku <a href="#https-konfigurointi">HTTPS-konfigurointi</a></p>
</div>
</div>
</input></input></div>
<h3 id="buildin-kaynnistaminen">Buildin käynnistäminen</h3>
<p>Julkaisun jälkeen uusi julkaisu voidaan käynnistää manuaalisesti web-käyttöliittymästä tai komentorivillä <code>oc</code>-komennolla.<br/>
<div class="highlight"><pre><span></span><code>oc<span class="w"> </span>start-build<span class="w"> </span>&lt;build-config-name&gt;
</code></pre></div>
- <code>&lt;build-config-name&gt;</code> on oletusarvoisesti sama kuin <code>&lt;deployment-config-name&gt;</code></p>
<p>Build voidaan myös automatisoida tapahtumaan aina, kun GitHub-repositorioon pusketaan uusi versio lähdekoodista</p>
<h3 id="buildin-automatisointi">Buildin automatisointi</h3>
<p>Jos sovellukselle on <em>build config</em>, jolla julkaisu tehdään GitHub-repositoriosta, voidaan build konfiguroida käynnistymään automaattisesti, kun repositorioon pusketaan uutta koodia.</p>
<p>Uusi build liipaistaan määrittämällä GitHub-repositorioon <em>webhook</em>, jota repositorio kutsuu aina, kun uusia muutoksia pusketaan.</p>
<p>Webhook-URL löytyy Rahti-palvelun käyttöliittymässä kohdata <em>Builds</em>.</p>
<p><img alt="" src="../img/rahti_find_webhook_url.png"/></p>
<p>Kopioi URL ja lisää se Github-repositorioon GitHubin web-käyttöliittymän kohdassa <em>Settings/Webhooks/Add webhook</em>.</p>
<p><img alt="" src="../img/github_add_webhook_ui.png"/></p>
<p>Content type-asetuksen tulee olla <code>application/json</code>.</p>
<h2 id="spring-boot-palvelimen-konfigurointi-kayttamaan-ulkoista-tietokantapalvelua">Spring Boot -palvelimen konfigurointi käyttämään ulkoista tietokantapalvelua</h2>
<div class="mermaid">flowchart LR
  classDef highlight fill:#ffe2ff,stroke:#996d99,stroke-width:3px;

  step1[Rahti-projektin luonti]
  step2[Tietokantapalvelun luonti]
  step3[Spring Boot -palvelimen julkaisu]
  step4[Tietokannan konfigurointi]

  step1--&gt;step2
  step2--&gt;step3
  step3--&gt;step4:::highlight</div>
<p>Seuraavassa esimerkissä konfiguroidaan Spring Boot -palvelin käyttämään projektiin luotua tietokantapalvelua.</p>
<p>Esimerkissä palvelimessa käytettävän tietokannan asetukset hallitaan käyttämällä Spring-profiileja: tietokantakonfiguraatiota varten määritellään oma profiili, joka määritellään käyttöön julkaisuympäriristössä.</p>
<h3 id="julkaisuprofiilin-luonti-spring-projektiin">Julkaisuprofiilin luonti Spring-projektiin</h3>
<p>Profiili voidaan määritellä laatimalla projektiin profiilikohtainen <code>application.properties</code>-määritys. Sen nimeksi tulee asettaa <code>application-&lt;profiilinimi&gt;.properties</code>. Jos esimerkiksi profiilin nimeksi valitaan <code>rahti</code>, tiedoston nimi on <code>application-rahti.properties</code>.</p>
<p>Profiilikohtaiset asetukset luetaan globaalien asetusten lisäksi. Näin esim. julkaisukonfiguraatioparametrit voidaan määritellä jokaista julkaisuympäristöä varten eri tiedostoihin.</p>
<p>Seuraavassa esimerkissä käytetään palvelimen ajoympäristöstä luettavia ympäristömuuttuja-arvoja. Näin julkaisuympäristön konfiguraatioparametreja ei tarvitse viedä versionhallintaan.</p>
<p>Rahti-projektiin luotavat kontit saavat projektiin luodun tietokantapalvelun tiedot ajoympäristöön määritetyistä ympäristömuuttujista, joiden nimi muodostetaan tietokantapalvelun nimen perusteella seuraavasti:
<div class="no-copy highlight"><pre><span></span><code><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">&lt;tietokantapalvelun nimi&gt;_SERVICE_HOST</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">&lt;tietokantapalvelun nimi&gt;_SERVICE_PORT</span>
</code></pre></div></p>
<p>Voit avata kontin Terminal-näkymän ja tarkastella ympäristömuuttujia <code>env</code> komennolla. Alla olevassa kuvassa ympäristömuuttujista on listattu muuttujat, jotka kertovat tietokantapalvelun, jonka nimi on <code>mysql-service</code>, tiedot muille Rahti-projektin konteille.</p>
<p><img alt="" src="../img/rahti_pod_env_example.png"/></p>
<p>Esimerkki profiilimääritystiedoston sisällöstä, jos tietokantapalvelun nimeksi on asetettu <code>db-service</code>:
<div class="highlight"><pre><span></span><code>spring.datasource.url=jdbc:mysql://${DB_SERVICE_SERVICE_HOST}:${DB_SERVICE_SERVICE_PORT}/${DB_NAME}
spring.datasource.username=${DB_USER}
spring.datasource.password=${DB_PASSWORD}
spring.jpa.show-sql=true
spring.jpa.generate-ddl=true
spring.jpa.hibernate.ddl-auto=update
</code></pre></div></p>
<p>Huom: Tietokantapalvelinta kytkettäessä muihin kontteihin, on tärkeää käyttää muuttujanimiä eikä esim. IP-osoitetta suoraan. IP-osoitteet voivat muuttua esimerkiksi kontin uudelleen käynnistymisen yhteydessä</p>
<h3 id="ymparistomuuttujien-asettaminen">Ympäristömuuttujien asettaminen</h3>
<p>Profiiliin määritellyt ympäristömuuttujat pitää vielä asettaa. Voit määritellä käynnistettävälle kontille ympäristömuuttujia Rahti-palvelun web-käyttöliittymässä kohdassa <em>Applications/Deployments</em>:</p>
<p><img alt="" src="../img/rahti_deployment_config_env_variables.png"/></p>
<p>Ympäristömuuttujan arvon voidaan määritellä suoraan tai valita sen jostain projektiin luodusta salaisuudesta. </p>
<p>Ylläolevassa esimerkissä MySQL-tietokannan tietokantakäyttäjän nimi <code>DB_USER</code> ja salasana <code>DB_PASSWORD</code> sekä tietokannan nimi <code>DB_NAME</code> luetaan salaisuudesta, joka luotiin tietokantapalvelun lisäämisen yhteydessä. Aktiivisen profiilin asettavan ympäristömuuttujan arvo <code>SPRING_PROFILES_ACTIVE</code> annetaan suoraan.</p>
<p>Kun julkaisu seuraavan kerran tehdään, käynnistyvässä kontissa ympäristömuuttujat on määritelty.</p>
<h2 id="https-konfigurointi">HTTPS-konfigurointi</h2>
<p>Julkaistu palvelu tarjotaan oletusarvoisesti vain HTTP-protokollalla. Palvelu voidaan konfiguroida tarjottavaksi myös HTTPS-protokollalla tai pelkästään HTTPS-protokollalla.</p>
<p>Konfiguroinnin voi tehdä komentorivillä komennolla 
<div class="highlight"><pre><span></span><code>oc<span class="w"> </span>create<span class="w"> </span>route<span class="w"> </span>edge<span class="w"> </span>--service<span class="o">=</span>&lt;service-name&gt;
</code></pre></div></p>
<p>Jos olet jo luonut suojaamattoman reitin eikä komento siksi onnistu, voit poistaa vanhan reitin komennolla 
<div class="highlight"><pre><span></span><code>oc<span class="w"> </span>delete<span class="w"> </span>route<span class="w"> </span>&lt;route-name&gt;
</code></pre></div>
- <code>&lt;route-name&gt;</code> on reitin nimi. Reitin nimi on oletusarvoisesti sama kuin palvelun nimi. Voit listata olemassaolevat reitit komennolla <code>oc get route</code>.</p>
<p>Web-käyttöliittymässä määritys tehdään Rahti-sovelluksen Route-määrittelyssä.</p>
<p><img alt="" src="../img/rahti_routes.png"/></p>
<p><img alt="" src="../img/rahti_route_edit.png"/></p>
<p>Reitille voidaan konfiguroida TLS käyttöön. Jos sertifikaatin jättää määrittämättä, käytetään oletussertifikaattia. HTTP-liikenteen voi joko sallia, estää tai uudelleenohjata.</p>
<p><img alt="" src="../img/rahti_route_enable_tls.png"/></p>
<p>Lisätietoa: <a href="https://docs.csc.fi/cloud/rahti/networking/">Rahti Docs: Networking</a></p>
<h2 id="virheenjaljitys">Virheenjäljitys</h2>
<p>Käynnissä olevien konttien (<em>pod</em>) tietoja voidaan tarkastella Rahti-palvelun hallintaliittymässä.</p>
<p>Käynnissä olevat kontit löytyvät helposti Overview-näkymästä.</p>
<p><img alt="" src="../img/rahti_overview_pods_highlight.png"/></p>
<p>Lokeja voi tarkastella välilehdellä <em>Logs</em>:</p>
<p><img alt="" src="../img/rahti_pod_log.png"/></p>
<p>Konttiin saa pääteyhteyden välilehdellä <em>Terminal</em>:</p>
<p><img alt="" src="../img/rahti_pod_terminal.png"/></p>
<p>Konttiin saa ssh-yhteyden myös komentorivillä komennolla <code>oc rsh &lt;nimi&gt;</code>. Projektin kontit voi listata komennolla <code>oc get pods</code>.</p>
<div class="highlight"><pre><span></span><code>PS<span class="w"> </span>&gt;<span class="w"> </span>oc<span class="w"> </span>get<span class="w"> </span>pods
NAME<span class="w">                  </span>READY<span class="w">     </span>STATUS<span class="w">      </span>RESTARTS<span class="w">   </span>AGE
dbservice-1-p2smq<span class="w">     </span><span class="m">1</span>/1<span class="w">       </span>Running<span class="w">     </span><span class="m">0</span><span class="w">          </span>4h
ticketguru-11-sbqhn<span class="w">   </span><span class="m">1</span>/1<span class="w">       </span>Running<span class="w">     </span><span class="m">0</span><span class="w">          </span>1h
PS<span class="w"> </span>&gt;<span class="w"> </span>oc<span class="w"> </span>rsh<span class="w"> </span>ticketguru-11-sbqhn
~<span class="w"> </span>$<span class="w"> </span>
</code></pre></div>
<p>Tietokantaa voi tarkastella tietokantajärjestelmän komentorivityökaluilla tietokantakontin pääteyhteydellä, esim. 
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>mysql<span class="w"> </span>-u<span class="w"> </span>dbuser<span class="w"> </span>-p<span class="w"> </span>dbname
</code></pre></div></p>
<h2 id="projektin-uudelleenluonti">Projektin uudelleenluonti</h2>
<p>Jos sovelluksen luonti <code>oc new-app</code>-komennolla jostain syystä ei onnistu, komennon uudelleenyrittäminen voi olla hankalaa, koska joitakin resursseja on jo luotu.</p>
<p>Helpointa saattaa olla poistaa koko Rahti-projekti ja luoda se alusta saakka uudelleen komentorivikomennnoin.</p>
<p>Seuraavissa esimerkeissä poistettavan ja uudelleen luotavan projektin nimi on <code>myproj</code>.
<div class="highlight"><pre><span></span><code>oc delete project myproj
oc new-project myproj --description='csc_project:200xxxx'
</code></pre></div>
-  <code>xxxx</code> korvataan oman CSC-projektin tunnisteen neljällä viimeisellä numerolla</p>
<h2 id="julkaisu-paikallisesta-hakemistosta-jkube-openshift-maven-pluginilla">Julkaisu paikallisesta hakemistosta JKube OpenShift Maven pluginilla</h2>
<p>Eclipse JKube on kokoelma lisäosia ja kirjastoja, joiden avulla helpotetaan Java-ohjelmistojen kontittamista ja julkaisua OpenShift konttipalveluun. JKube OpenShift Maven pluginilla voidaan julkaista sovellus kehitysympäristöstä suoraan paikallisesta hakemistosta (siis ei GitHub-repositoriosta). </p>
<p>Tätä julkaisua ei voi samalla tavoin automatisoida kuin GitHubista tehtäviä julkaisuja.</p>
<p>Lisäosan käyttöönotto on suoraviivaista: Lisää Spring Boot projektin pom.xml tiedostoon JKube-lisäosan määritys:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;build&gt;</span>
<span class="w">    </span><span class="nt">&lt;plugins&gt;</span>

<span class="w">        </span><span class="nt">&lt;plugin&gt;</span>
<span class="w">            </span><span class="nt">&lt;groupId&gt;</span>org.eclipse.jkube<span class="nt">&lt;/groupId&gt;</span>
<span class="w">            </span><span class="nt">&lt;artifactId&gt;</span>openshift-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">        </span><span class="nt">&lt;/plugin&gt;</span>

<span class="w">    </span><span class="nt">&lt;/plugins&gt;</span>
<span class="nt">&lt;/build&gt;</span>
</code></pre></div>
<p>Kirjaudu rahti-palveluun komentorivin kautta.Tämän jälkeen julkaisu voidaan tehdä maven -komennolla:</p>
<p><div class="highlight"><pre><span></span><code>./mvnw<span class="w"> </span>package<span class="w"> </span>oc:build<span class="w"> </span>oc:resource<span class="w"> </span>oc:apply
</code></pre></div>
Komento valmistelee Java projektin, luo ja alustaa OpenShift ympäristöön soveltuvan kontin ja lataa kontin suoritukseen OpenShift ympäristöön.</p>
<p>Komennon päättymisen jälkeen Rahti-projektin Overview-näkymästä voit saada tietoa julkaisun tilasta ja onnistumisesta, sekä löydät julkaistun palvelun URL-osoitteen.</p>
<p><img alt="" src="../img/rahdit_project_overview_published.png"/></p>
<h3 id="ymparistomuuttujien-asettaminen-jkube-openshift-maven-pluginia-kaytettaessa">Ympäristömuuttujien asettaminen JKube OpenShift Maven pluginia käytettäessä</h3>
<p>Koska OpenShift Maven plugin yliajaa kaikki web-käyttöliittymässä tehdyt konttiasetukset, on sitä käytettäessä määritykset tehtävä pluginin määritystiedostossa.</p>
<p>Tarkista Rahti-palvelun hallintakäyttöliittymästä tietokannan luonnin yhteydessä luodun salaisuuden nimi. Tässä esimerkissä se on <code>mysql-secret</code>. </p>
<p>Lisää Spring sovelluksen hakemistorakenteeseen <code>src/main/jkube</code> tiedosto nimeltään <code>deployment.yml</code>.
<div class="highlight"><pre><span></span><code>spec:
  template:
    spec:
      containers:
        - env:
            - name: MYSQL_USER
              valueFrom:
                secretKeyRef:
                  key: database-user
                  name: mysql-secret
            - name: MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: database-password
                  name: mysql-secret
            - name: MYSQL_DATABASE
              valueFrom:
                secretKeyRef:
                  key: database-name
                  name: mysql-secret
            - name: SPRING_PROFILES_ACTIVE
              value: rahti
</code></pre></div></p>
<p>Parametrien selitykset:
- <code>name</code> on asetettavan ympäristömuuttujan nimi
- <code>valueFrom.secretKeyRef.name</code> määrittää, minkä nimisestä salaisuudesta arvo luetaan. Vaihda tähän omasta ympäristöstäsi oikea salaisuuden nimi.
- <code>valueFrom.secretKeyRef.key</code> määrittää, mistä salaisuuden kentästä arvo luetaan.
- Lopuksi asetaan ympäristömuuttujan SPRING_PROFILES_ACTIVE arvoksi halutun profiilin nimi. Käytettävä Spring-profiili voidaan asettaa ympäristömuuttujalla SPRING_PROFILES_ACTIVE.</p>
<p>Huomaa, että tiedostomuoto on YAML. Sen rakenteeseen on tarvittaessa hyvä hakea vinkkiä web-käyttöliittymästä valitsemalla tietokantapodin valikosta <em>Edit YAML</em>.</p>
<p>Suorita uudelleen komento 
<div class="highlight"><pre><span></span><code> ./mvnw package oc:build oc:resource oc:apply
</code></pre></div>
Rahti-projektin <em>Overview</em>-näkymässä voi seurata julkaisun etenemistä. Onnistuneen julkaisun jälkeen näkymässä näkyy, että sekä sovelluspalvelinkontti(Spring Boot-palvelin) että tietokantapalvelinkontti ovat käynnissä.</p>
<p><img alt="" src="../img/rahti_publish_success.png"/></p>
</article>
</div>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "navigation.tabs", "toc.integrate", "navigation.top"], "search": "../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Kopioitu leikep\u00f6yd\u00e4lle", "clipboard.copy": "Kopioi leikep\u00f6yd\u00e4lle", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "Ei t\u00e4sm\u00e4\u00e4vi\u00e4 dokumentteja", "search.result.one": "1 t\u00e4sm\u00e4\u00e4v\u00e4 dokumentti", "search.result.other": "# t\u00e4sm\u00e4\u00e4v\u00e4\u00e4 dokumenttia", "search.result.placeholder": "Kirjoita aloittaaksesi haun", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../assets/javascripts/bundle.6c14ae12.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
mermaid.initialize({});</script></body>
</html>